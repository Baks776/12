# Телеграм-бот: планировщик сообщений

## Описание

Бот для планирования автоматической отправки сообщений в Telegram чаты и группы по расписанию. Поддерживает отправку текстовых сообщений и медиафайлов (фото, видео, документы) с настраиваемым расписанием.

## Основные возможности

- ✅ Планирование отправки сообщений по времени (HH:MM)
- ✅ Фильтрация по дням недели (пн, вт, ср, и т.д.)
- ✅ Фильтрация по числу месяца (1-31)
- ✅ Поддержка медиафайлов (photo, video, document)
- ✅ Система администрирования (только админы могут управлять ботом)
- ✅ Локальное хранение задач в JSON файле
- ✅ Автоматическая синхронизация расписания

## Установка и настройка

### Шаг 1: Установка Python и зависимостей

1. **Установите Python 3.11 или новее**
   - Скачайте с [python.org](https://www.python.org/downloads/)
   - При установке отметьте "Add Python to PATH"

2. **Создайте виртуальное окружение** (рекомендуется)
   ```bash
   python -m venv venv
   ```

3. **Активируйте виртуальное окружение**
   - Windows:
     ```bash
     venv\Scripts\activate
     ```
   - Linux/Mac:
     ```bash
     source venv/bin/activate
     ```

4. **Установите зависимости**
   ```bash
   pip install -r requirements.txt
   ```

### Шаг 2: Создание Telegram бота

1. Откройте Telegram и найдите бота [@BotFather](https://t.me/BotFather)
2. Отправьте команду `/newbot`
3. Следуйте инструкциям:
   - Укажите имя бота (например: "Мой Планировщик")
   - Укажите username бота (должен заканчиваться на `bot`, например: `my_scheduler_bot`)
4. **Скопируйте токен бота** — он понадобится в следующем шаге

### Шаг 3: Узнайте свой Telegram ID

1. Найдите бота [@userinfobot](https://t.me/userinfobot) в Telegram
2. Отправьте ему любое сообщение
3. Бот ответит вашим **ID** (число вида `123456789`)
4. **Сохраните этот ID** — он нужен для настройки админа

### Шаг 4: Настройка переменных окружения

Создайте файл `.env` в корневой папке проекта со следующим содержимым:

```env
# Обязательные параметры
TELEGRAM_BOT_TOKEN=ваш_токен_от_BotFather

# ID администраторов (через запятую, без пробелов)
# Пример: ADMIN_IDS=123456789,987654321
ADMIN_IDS=ваш_telegram_id

# Опциональные параметры
TZ=Europe/Moscow
DEFAULT_PARSE_MODE=HTML
TASKS_FILE=tasks.json
ADMINS_FILE=admins.json
```

**Важно:**
- Замените `ваш_токен_от_BotFather` на токен, полученный от @BotFather
- Замените `ваш_telegram_id` на ваш ID из шага 3
- Можно указать несколько админов через запятую: `ADMIN_IDS=123456789,987654321`

### Шаг 5: Первый запуск

1. Запустите бота:
   ```bash
   python main.py
   ```

2. Если все настроено правильно, вы увидите в консоли:
   ```
   INFO:tg_scheduler:Starting bot scheduler
   INFO:tg_scheduler:Loaded X tasks from tasks.json
   INFO:tg_scheduler:Scheduler started; jobs loaded.
   ```

3. Откройте Telegram и найдите вашего бота
4. Отправьте команду `/start`
5. Если вы админ, бот покажет список команд включая админ-команды

### Шаг 6: Добавление бота в группу (опционально)

Если вы хотите отправлять сообщения в группу:

1. Создайте группу в Telegram или откройте существующую
2. Добавьте вашего бота в группу
3. Дайте боту права администратора (или хотя бы право отправлять сообщения)
4. Отправьте в группе команду `/chat_id`
5. Бот ответит ID группы (число вида `-1001234567890`)
6. Используйте этот ID при создании задач

## Команды бота

### Команды для всех пользователей

- `/start` — показать список команд
- `/help` — подробная справка по командам
- `/chat_id` — узнать ID текущего чата или группы

### Команды для администраторов

Только администраторы могут управлять задачами:

- `/add_task` — добавить новую задачу
- `/list_tasks` — показать список всех задач
- `/delete_task <ID>` — удалить задачу по ID
- `/edit_task` — редактировать задачу (в разработке)

### Админ-команды для управления администраторами

- `/add_admin <ID>` — добавить администратора (или ответьте на сообщение пользователя)
- `/remove_admin <ID>` — удалить администратора
- `/list_admins` — показать список всех администраторов

## Использование команды /add_task

### Базовый синтаксис

```
/add_task <время> <сообщение> [параметры]
```

### Параметры

- `<время>` — время в формате HH:MM (например: `09:00`, `21:30`)
- `<сообщение>` — текст сообщения
- `[chat_id]` — **опционально**, ID группы/чата для отправки (если не указан — используется текущий чат)
- `[дни недели]` — опционально, дни недели через запятую: `пн,вт,ср` или `mon,tue,wed`
- `[число месяца]` — опционально, число от 1 до 31
- `[тип медиа]` — опционально: `photo`, `video` или `document`
- `[ссылка медиа]` — опционально, URL файла или file_id Telegram

### Примеры использования

**Простое сообщение каждый день (в текущий чат):**
```
/add_task 09:00 Доброе утро!
```

**Сообщение в определенные дни недели:**
```
/add_task 12:00 Обед пн,ср,пт
```

**Сообщение в конкретную группу:**
```
/add_task 09:00 Доброе утро! -1001234567890
```

**Сообщение в определенное число месяца:**
```
/add_task 15:00 Напоминание о платеже 15
```

**Сообщение с фото в конкретную группу:**
```
/add_task 18:00 Вечернее фото -1001234567890 пн,ср,пт,вс photo https://example.com/image.jpg
```

**Комбинированные условия (дни недели И число месяца):**
```
/add_task 10:00 Важное сообщение пн,ср,пт 15
```

**Сообщение в группу с указанием всех параметров:**
```
/add_task 09:00 Еженедельное напоминание -1001234567890 пн,ср,пт 15
```

### Как узнать ID группы

1. Добавьте бота в группу
2. Дайте боту права администратора (или хотя бы право отправлять сообщения)
3. Отправьте в группе команду `/chat_id`
4. Бот ответит ID группы (обычно начинается с `-100`, например: `-1001234567890`)

### Примечания

- Если указаны и дни недели, и число месяца, сообщение отправится только когда совпадут **оба** условия
- Для медиа нужно указать и тип (`photo`/`video`/`document`), и ссылку
- Можно использовать русские (`пн,вт,ср`) или английские (`mon,tue,wed`) названия дней
- Если `chat_id` не указан, задача создается для текущего чата (где отправлена команда)
- `chat_id` можно указать в любом месте команды после времени и сообщения
- `chat_id` группы обычно начинается с `-100` и содержит 13-14 цифр
- `chat_id` личного чата — это просто число (ваш Telegram ID)

## Управление администраторами

### Добавление первого администратора

**Способ 1: Через переменную окружения (рекомендуется)**

Добавьте в файл `.env`:
```env
ADMIN_IDS=123456789
```

При первом запуске бота этот ID автоматически добавится в список админов.

**Способ 2: Через команду (если уже есть админ)**

Если у вас уже есть хотя бы один админ, он может добавить других:
```
/add_admin 123456789
```

Или ответьте на сообщение пользователя командой `/add_admin`.

### Удаление администратора

Только существующий админ может удалить другого админа:
```
/remove_admin 123456789
```

**Важно:** Вы не можете удалить себя из списка админов.

### Просмотр списка администраторов

```
/list_admins
```

## Структура файлов

После первого запуска создадутся следующие файлы:

- `tasks.json` — хранилище всех задач
- `admins.json` — список администраторов
- `.env` — переменные окружения (создайте вручную)

**Важно:** Не удаляйте эти файлы, иначе потеряете все задачи и настройки админов!

## Формат хранения данных

### tasks.json

```json
{
  "task_id": {
    "task_id": "уникальный_идентификатор",
    "chat_id": "ID_чата",
    "time_str": "09:00",
    "weekdays": ["mon", "wed", "fri"],
    "monthday": null,
    "message": "Текст сообщения",
    "media_type": null,
    "media_url": null,
    "parse_mode": "HTML",
    "enabled": true
  }
}
```

### admins.json

```json
{
  "admins": [
    "123456789",
    "987654321"
  ]
}
```

## Решение проблем

### Бот не отвечает на команды

1. Проверьте, что токен бота правильный в `.env`
2. Убедитесь, что бот запущен (нет ошибок в консоли)
3. Проверьте, что вы являетесь администратором (используйте `/list_admins`)

### Ошибка "У вас нет прав администратора"

1. Убедитесь, что ваш ID добавлен в список админов
2. Проверьте файл `admins.json` — там должен быть ваш ID
3. Если файла нет или он пуст, добавьте `ADMIN_IDS` в `.env` и перезапустите бота

### Сообщения не отправляются

1. Проверьте, что бот имеет права на отправку сообщений в группу
2. Убедитесь, что время задачи указано правильно (HH:MM)
3. Проверьте логи на наличие ошибок
4. Убедитесь, что задача активна (`enabled: true` в tasks.json)

### Задачи не сохраняются

1. Проверьте права на запись в файл `tasks.json`
2. Убедитесь, что файл не заблокирован другим процессом
3. Проверьте логи на наличие ошибок сохранения

### Как узнать ID чата или группы

1. Добавьте бота в чат/группу
2. Отправьте команду `/chat_id`
3. Бот ответит ID

**Важно:** ID группы обычно начинается с `-100` (например: `-1001234567890`)

## Безопасность

- ⚠️ **Не публикуйте** файл `.env` в публичных репозиториях
- ⚠️ **Не публикуйте** файлы `tasks.json` и `admins.json` — они содержат конфиденциальную информацию
- ⚠️ Храните токен бота в секрете
- ⚠️ Регулярно делайте резервные копии файлов `tasks.json` и `admins.json`

## Дополнительные настройки

### Изменение часового пояса

В файле `.env`:
```env
TZ=Europe/Moscow
```

Доступные таймзоны: `Europe/Moscow`, `UTC`, `America/New_York` и т.д.

### Изменение режима парсинга

В файле `.env`:
```env
DEFAULT_PARSE_MODE=HTML
```

Доступные значения: `HTML` или `Markdown`

### Изменение файлов хранения

В файле `.env`:
```env
TASKS_FILE=tasks.json
ADMINS_FILE=admins.json
```

## Технические детали

- Использует библиотеку `aiogram` для работы с Telegram API
- Использует `apscheduler` для планирования задач
- Задачи хранятся в JSON формате локально
- Автоматическая синхронизация расписания при изменении задач
- Поддержка повторных попыток отправки (до 3 раз)

## Лицензия

Этот проект предоставляется "как есть" без каких-либо гарантий.

## Поддержка

При возникновении проблем:
1. Проверьте раздел "Решение проблем" выше
2. Проверьте логи в консоли
3. Убедитесь, что все зависимости установлены правильно
